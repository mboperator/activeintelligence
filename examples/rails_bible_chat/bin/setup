#!/usr/bin/env ruby

require 'fileutils'

# Change to the application root directory
APP_ROOT = File.expand_path('..', __dir__)
Dir.chdir APP_ROOT do
  puts '== Installing dependencies =='
  system! 'gem install bundler --conservative'
  system('bundle check') || system!('bundle install')

  puts "\n== Preparing database =="
  system! 'bin/rails db:prepare'

  puts "\n== Removing old logs and tempfiles =="
  system! 'bin/rails log:clear tmp:clear'

  puts "\n== Checking for ANTHROPIC_API_KEY =="
  if ENV['ANTHROPIC_API_KEY'].nil? || ENV['ANTHROPIC_API_KEY'].empty?
    puts "\n⚠️  WARNING: ANTHROPIC_API_KEY environment variable is not set!"
    puts "   Set it with: export ANTHROPIC_API_KEY='sk-ant-...'"
  else
    puts "✓ ANTHROPIC_API_KEY is configured"
  end

  puts "\n== Setup complete! =="
  puts "\nTo start the server:"
  puts "  cd #{APP_ROOT}"
  puts "  bundle exec rails server"
  puts "\nThen visit: http://localhost:3000"
end

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end
